<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#soap_default" aria-controls="soap_default" role="tab"
            data-toggle="tab">SOAP</a>
    </li>
    <li role="presentation"><a href="#gambar" aria-controls="gambar" role="tab" data-toggle="tab">Gambar Catatan
            Pemeriksaan</a></li>
</ul>

<link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/jquery-minicolors/2.3.5/jquery.minicolors.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-minicolors/2.3.5/jquery.minicolors.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<div class="panel-default">
    <div class="panel-body">
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade in active" id="soap_default">
                <form name="dokter_ralan"
                    action="{?=url(ADMIN.'/dokter_ralan/soapsave/'.@$dokter_ralan.no_rawat)?}#soap" method="POST">
                    <div class="panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Subjective</h3>
                        </div>
                        <div class="panel-body">
                            <div class="post">
                                <div class="post-content">
                                    <div class="form-group">
                                        <label>Keluhan</label>
                                        <textarea name="keluhan" class="form-control"
                                            rows="4">{$dokter_ralan.soap.keluhan}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading">
                            <h3 class="panel-title">Objective</h3>
                        </div>
                        <div class="panel-body">
                            <div class="post">
                                <div class="post-content">
                                    <div class="row clearfix">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Pemeriksaan</label>
                                                <textarea name="pemeriksaan" class="form-control"
                                                    rows="3">{$dokter_ralan.soap.pemeriksaan}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Penilaian</label>
                                                <textarea name="penilaian" class="form-control"
                                                    rows="3">{$dokter_ralan.soap.penilaian}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row clearfix {if: $admin_mode == 'simple'}hidden{/if}">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Tensi</label>
                                                <div class="input-group">
                                                    <input type="text" name="tensi" class="form-control"
                                                        value="{$dokter_ralan.soap.tensi}" />
                                                    <span class="input-group-addon">mmHg</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Nadi</label>
                                                <div class="input-group">
                                                    <input type="text" name="nadi" class="form-control"
                                                        value="{$dokter_ralan.soap.nadi}" />
                                                    <span class="input-group-addon">x/menit</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>RR</label>
                                                <div class="input-group">
                                                    <input type="text" name="respirasi" class="form-control"
                                                        value="{$dokter_ralan.soap.respirasi}" />
                                                    <span class="input-group-addon">x/menit</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row clearfix {if: $admin_mode == 'simple'}hidden{/if}">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Suhu</label>
                                                <div class="input-group">
                                                    <input type="text" name="suhu_tubuh" class="form-control"
                                                        value="{$dokter_ralan.soap.suhu_tubuh}" />
                                                    <span class="input-group-addon">&#8451;</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Tinggi</label>
                                                <div class="input-group">
                                                    <input type="text" name="tinggi" class="form-control"
                                                        value="{$dokter_ralan.soap.tinggi}" />
                                                    <span class="input-group-addon">cm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Berat</label>
                                                <div class="input-group">
                                                    <input type="text" name="berat" class="form-control"
                                                        value="{$dokter_ralan.soap.berat}" />
                                                    <span class="input-group-addon">kg</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row clearfix {if: $admin_mode == 'simple'}hidden{/if}">
                                        <div class="col-sm-3">
                                            <label for="nama_pasien">GCS(E,V,M)</label>
                                            <input type="text" name="gcs" class="form-control" placeholder=""
                                                value="{$dokter_ralan.soap.berat}">
                                        </div>
                                        <div class="col-sm-3">
                                            <label for="nama_pasien">Kesadaran</label>
                                            <select class="form-control" name="kesadaran" width="100%">
                                                {loop: $dokter_ralan.pemeriksaan_ralan.kesadaran}
                                                <option value="{$value}" {if: $dokter_ralan.soap.kesadaran==$value}
                                                    selected{/if}>{$value} </option> {/loop} </select> </div> <div
                                                    class="col-sm-3">
                                                    <label for="nama_pasien">Alergi</label>
                                                    <input type="text" name="alergi" class="form-control" placeholder=""
                                                        value="{$dokter_ralan.soap.alergi}">
                                        </div>
                                        <div class="col-sm-3">
                                            <label for="lingkar_perut">Lingkar Perut</label>
                                            <input type="text" name="lingkar_perut" class="form-control" placeholder=""
                                                value="{$dokter_ralan.soap.lingkar_perut}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading">
                            <h3 class="panel-title">Assessment</h3>
                        </div>
                        <div class="panel-body">
                            <div class="post">
                                <div class="post-content">
                                    <div class="row clearfix">
                                        <div class="col-md-4 {if: $admin_mode == 'simple'}hidden{/if}">
                                            <div class="form-group">
                                                <label>Diagnosa (ICD-10)</label>
                                                <select name="kd_penyakit[]" class="form-control icd10_" multiple
                                                    data-keep-open="true" data-use-dimmer="false"
                                                    data-options-height="126px">
                                                    {loop: $dokter_ralan.diagnosa_pasien}
                                                    <option value="{$value.kd_penyakit}" selected>{$value.nm_penyakit}
                                                    </option>
                                                    {/loop}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4 {if: $admin_mode == 'simple'}hidden{/if}">
                                            <div class="form-group">
                                                <label>Tindakan (ICD-9)</label>
                                                <select name="kode[]" class="form-control icd9_" multiple
                                                    data-keep-open="true" data-use-dimmer="false"
                                                    data-options-height="126px">
                                                    {loop: $dokter_ralan.prosedur_pasien}
                                                    <option value="{$value.kode}" selected>{$value.deskripsi_pendek}
                                                    </option>
                                                    {/loop}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="{if: $admin_mode == 'simple'}col-md-12{else}col-md-4{/if}">
                                            <div class="form-group">
                                                <label>Perawatan</label>
                                                <select name="kd_jenis_prw[]" class="form-control jns_perawatan" multiple
                                                    data-keep-open="true" data-use-dimmer="false"
                                                    data-options-height="126px">
                                                    {loop: $dokter_ralan.rawat_jl_dr}
                                                    <option value="{$value.kd_jenis_prw}" selected>{$value.nm_perawatan}
                                                    </option>
                                                    {/loop}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading">
                            <h3 class="panel-title">Plan</h3>
                        </div>
                        <div class="panel-body">
                            <div class="post">
                                <div class="post-content">
                                    <div class="row clearfix">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Rencana Tindak Lanjut</label>
                                                <textarea name="rtl" class="form-control"
                                                    rows="2">{$dokter_ralan.soap.rtl}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Catatan Perawatan</label>
                                                <textarea name="catatan" class="form-control"
                                                    rows="2">{$dokter_ralan.catatan.catatan}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="post">
                                <div class="post-content">
                                    <input type="submit" name="save" class="btn btn-primary" value="Simpan" />
                                    <a href="#" class="btn btn-default">Batal</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div role="tabpanel" class="tab-pane fade in" id="gambar">
                <style>
                    .signature-pad {
                        width: 100%;
                        height: 85vh;
                        background-color: white;
                    }
                </style>
                <div id="gambar-panel">
                    <div class="row" style="margin: 0;">
                        <h3 id="title-pad"> Catatan Pemeriksaan <button class="btn btn-primary" style="margin-bottom: 10px; float: right;" id="onSignaturePad" onclick="openFullscreen()"> Mulai Membuat Catatan Pemeriksaan</button></h3>
                        <div class="col-md-12 signature-wrap" id="signature-wrap" style="margin-top: 10px;">
                            <div class="row" style="background-color: #EEEEEE; margin:auto;">
                                <div class="col-md-3 col-xs-6">
                                    <div class="input-group">
                                        <div class="input-group-addon"><b> Color : </b></div>
                                        <style>
                                            .minicolors {
                                                padding: 9px 13%;
                                            }
                                        </style>
                                        <input type="hidden" class="mcPen" name="ColorPen" id="colorPen"
                                            oninput="changePenColor()" value="#000000">
                                    </div>
                                </div>

                                <div class="col-md-3 col-xs-6">
                                    <div class="input-group">
                                        <div class="input-group-addon"><b> Size : </b></div>
                                        <input type="range" min="0.5" max="20" class="form-control" name="SizePen"
                                            id="sizePen" oninput="changePenSize()" value="1.5">
                                        <!-- <div class="input-group-addon" id="sizePenTxt" style="font-weight: bold;">1.5</div> -->
                                        <div class="input-group-addon"></div>
                                    </div>
                                </div>

                                <div class="col-md-3 col-xs-6" style="float:right; margin-top: 3px;">
                                    <button type="button" class="btn btn-primary btn-sm" style="width: 48%;"
                                        onclick="saveGambar()"><i class="fa fa-save"></i> Simpan</button>

                                    <button class="btn btn-danger btn-sm" style="float:right; width: 48%;" id="offSignaturePad"
                                        onclick="closeFullscreen()"><i class="fa fa-times"></i> Batal</button>
                                </div>

                                <div class="col-md-3 col-xs-6" style="float:right; margin-top: 3px;">
                                    <center>
                                        <button type="button" class="btn btn-default btn-sm" id="modeEraser"
                                            style="width: 48%;" onclick="modeEraserOnOff()"><i class="fa fa-eraser">
                                                Eraser</i></button>
                                        <button type="button" class="btn btn-danger btn-sm" style="width: 48%;"
                                            onclick="clearCanvas()"><i class="fa fa-file"> Clear</i></button>
                                    </center>
                                </div>
                            </div>

                            <div>
                                <canvas id="signature-pad" class="signature-pad" width="1000px" height="1000px"
                                    style="border: 2px solid #EEEEEE;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalGambar" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Hasil Catatan Pemeriksaan
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </h5>
                                </div>
                                <form id="formeresep" method="post" action="{?=url(ADMIN.'/dokter_ralan/uploadgambarpemeriksaan/'.@$dokter_ralan.no_rawat)?}">
                                <div class="modal-body"></div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                    <button type="submit" value="submit" form="formeresep" class="btn btn-primary">Simpan
                                        Catatan</button>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Data Gambar Catatan Pemeriksaan</h3>
                    </div>
                    <div class="panel-body" style="background-color: #EEE;padding: 8px; margin: 0;">
                        <div class="gallery">
                            {if: !empty($pemeriksaan_catatan)}
                                {loop: $pemeriksaan_catatan}
                                <div style="background-color: #FFF; border-radius: 5px;">
                                    <div class="row" style="padding: 5px;">
                                        <div class="text-info col-sm-11 col-xs-9">
                                            <h5 style="margin: 5px;">Catatan Pemeriksaan : <br> {$value.nama} ( {$value.waktu_catatan} )
                                            </h5>
                                        </div>
                                        <div class="col-sm-1 col-xs-3"  style="text-align: right;">
                                                <button onclick="deleteGambar('{$dokter_ralan.no_rawat}','{$value.gambar_catatan}')" class="btn btn-danger"> <i class="fa fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <hr style="margin: 0 2px 5px;">
                                    <div class="thumbnail">
                                        <a href="{?=url(UPLOADS) ?}/catatan_pemeriksaan/{$value.gambar_catatan}" target="_blank" class="images">
                                            <img src="{?=url(UPLOADS) ?}/catatan_pemeriksaan/{$value.gambar_catatan}" class="img-responsive">
                                        </a>
                                    </div>
                                </div>
                                {/loop}
                            {else}
                                <h4 class="text-center bg-warning" style="background-color: #FFF; color: black;">Tidak ada catatan</h4>
                            {/if}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    var canvas = document.getElementById("signature-pad");
    var signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        minWidth: 0.5,
        maxWidth: 1.5,
    });

    var elem = document.getElementById("gambar-panel");
    if (elem.fullscreenElement !== null) {
        $('#signature-wrap').hide();
    }

    function openFullscreen() {
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }

        screen.orientation.lock('landscape');

        checkOnOff();
        elem.style.backgroundColor = '#a0a0a0';
        $('#title-pad').hide();
        $('#signature-wrap').show();
        signaturePad.on();
    }

    function closeFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            /* Safari */
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            /* IE11 */
            document.msExitFullscreen();
        }

        screen.orientation.lock('default');

        checkOnOff();
        elem.style.backgroundColor = '#FFFFFF';
        $('#title-pad').show();
        $('#signature-wrap').hide();
    }


    function resizeCanvas() {
        var ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);

        signaturePad.clear();
    }

    window.onresize = resizeCanvas;
    resizeCanvas();

    function clearCanvas() {
        signaturePad.clear();
        changePenColor();
        changePenSize();
    };

    function modeEraserOnOff() {
        if (canvas.getContext('2d').globalCompositeOperation == 'source-over') {
            $('#modeEraser').removeClass();
            $('#modeEraser').addClass('btn btn-success btn-sm')
            canvas.getContext('2d').globalCompositeOperation = 'destination-out';
        } else {
            $('#modeEraser').removeClass();
            $('#modeEraser').addClass('btn btn-default btn-sm')
            canvas.getContext('2d').globalCompositeOperation = 'source-over';
        }
    };

    function changePenColor() {
        var color = $("#colorPen").val();
        var r = parseInt(color.substr(1, 2), 16)
        var g = parseInt(color.substr(3, 2), 16)
        var b = parseInt(color.substr(5, 2), 16)
        var result = "rgb(" + r + "," + g + "," + b + ")";

        signaturePad.penColor = result;
    }

    function changePenSize() {
        var sizeMax = $("#sizePen").val();
        var sizeMin = sizeMax - 1;
        if (sizeMax <= 1) {
            sizeMin = 0.4
        }

        $('#sizePenTxt').html(sizeMax);
        signaturePad.minWidth = sizeMin;
        signaturePad.maxWidth = sizeMax;
    }

    function saveGambar() {
        if (signaturePad.isEmpty()) {
            alert("Tidak ada coretan!");
        } else {
            var data = signaturePad.toDataURL('image/png');
            var result = '<img src="' + data + '" width="100%" style="box-shadow:0px 1px 3px;">' +
                '<textarea id="gambar" name="gambar" style="display:none;">' + data + '</textarea>'
            $('#modalGambar').modal('show').find('.modal-body').html(result);
        }
    }

    function checkOnOff() {
        if ($('#onSignaturePad:visible').length == 0) {
            $('#onSignaturePad').show()
            $('#offSignaturePad').hide()
        } else {
            $('#onSignaturePad').hide()
            $('#offSignaturePad').show()
        }
    }

    function deleteGambar(no_rawat, gambar){
        console.log(no_rawat+' test '+gambar);
      	var gambar_split = gambar.split('.');
        var baseURL = mlite.url + '/' + mlite.admin;
        var url = baseURL + '/dokter_ralan/delgambarpemeriksaan/'+ no_rawat +'/'+ gambar_split[0] +'?t=' + mlite.token;
        bootbox.confirm('Apakah anda yakin mau menghapus gambar ini ?', function(conf){
            if (conf){
                window.location.href = url
            }
        })
    }

    $('#onSignaturePad').show()
    $('#offSignaturePad').hide()
    $('INPUT.mcPen').minicolors();
    
</script>